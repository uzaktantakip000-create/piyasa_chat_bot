apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: piyasa-chatbot

resources:
  - ../../base

namePrefix: prod-

labels:
  - pairs:
      environment: production

# Patch for production-specific settings
patches:
  # Increase replicas for production
  - target:
      kind: Deployment
      name: api
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: StatefulSet
      name: worker
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 6

  - target:
      kind: Deployment
      name: frontend
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  # Increase resource limits for production
  - target:
      kind: Deployment
      name: api
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "2000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "500m"

  - target:
      kind: StatefulSet
      name: worker
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "4Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "4000m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "1000m"

  # Aggressive HPA for production (API and Frontend only)
  # NOTE: Worker HPA is removed from base (coordination issues with TOTAL_WORKERS)
  - target:
      kind: HorizontalPodAutoscaler
      name: api-hpa
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 20

  # Worker scaling must be done manually:
  #   kubectl scale statefulset/worker --replicas=8 -n piyasa-chatbot
  #   Then update ConfigMap TOTAL_WORKERS=8 and restart pods

configMapGenerator:
  - name: piyasa-config
    behavior: merge
    literals:
      - LOG_LEVEL=INFO
      - TOTAL_WORKERS=6

# Production ingress with TLS
patchesStrategicMerge:
  - ingress-tls.yaml
