apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: worker
  namespace: piyasa-chatbot
  labels:
    app: piyasa-worker
    component: worker
spec:
  serviceName: worker-service
  replicas: 4
  selector:
    matchLabels:
      app: piyasa-worker
      component: worker
  template:
    metadata:
      labels:
        app: piyasa-worker
        component: worker
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8001"
        prometheus.io/path: "/metrics"
    spec:
      # Security context for pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
      - name: worker
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        # IMPORTANT: Use semantic versioning in production (not :latest)
        # Examples: api:v1.0.0, api:v1.0.1, api:v1.1.0
        # Using :latest makes rollbacks difficult and versions unclear
        image: ghcr.io/uzaktantakip000-create/piyasa_chat_bot/api:latest
        imagePullPolicy: Always
        # Wrapper script to extract WORKER_ID from pod name
        # StatefulSet pods are named: worker-0, worker-1, worker-2, etc.
        # We extract the ordinal number and export it as WORKER_ID
        command:
          - /bin/sh
          - -c
          - |
            # Extract ordinal from pod name (worker-0 -> 0, worker-1 -> 1, etc.)
            export WORKER_ID=$(echo $POD_NAME | grep -oE '[0-9]+$')
            echo "Starting worker with WORKER_ID=$WORKER_ID, TOTAL_WORKERS=$TOTAL_WORKERS"
            # Start application
            exec python worker.py
        ports:
        - containerPort: 8001
          name: metrics
          protocol: TCP
        env:
        # POD_NAME for extracting worker ordinal
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        # Database URL from Secret (contains password)
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: DATABASE_URL
        # Redis URL from Secret (contains password)
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: REDIS_URL
        # ConfigMap references
        - name: LLM_PROVIDER
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: LLM_PROVIDER
        - name: LLM_MODEL
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: LLM_MODEL
        - name: TELEGRAM_API_BASE
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: TELEGRAM_API_BASE
        - name: TELEGRAM_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: TELEGRAM_TIMEOUT
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: LOG_LEVEL
        - name: TOTAL_WORKERS
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: TOTAL_WORKERS
        - name: CACHE_L1_MAX_SIZE
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: CACHE_L1_MAX_SIZE
        # Worker metrics port (SESSION 38)
        - name: WORKER_METRICS_PORT
          value: "8001"
        # Secret references
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: OPENAI_API_KEY
        - name: GROQ_API_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: GROQ_API_KEY
        - name: GEMINI_API_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: GEMINI_API_KEY
        - name: TOKEN_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: TOKEN_ENCRYPTION_KEY
        # NOTE: WORKER_ID is now dynamically extracted in the command wrapper
        # from POD_NAME (no explicit env var needed)

        # Health checks for worker process
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "ps aux | grep -v grep | grep 'python worker.py' || exit 1"
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        # Note: No readinessProbe for worker (background process, no traffic)

        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
      # Image pull secret for GHCR (GitHub Container Registry)
      #
      # REQUIRED if repository is private. Uncomment and create secret:
      #   kubectl create secret docker-registry ghcr-secret \
      #     --docker-server=ghcr.io \
      #     --docker-username=<github-username> \
      #     --docker-password=<github-personal-access-token> \
      #     --namespace=piyasa-chatbot
      #
      # NOT REQUIRED if repository is public (image pulls work without auth)
      #
      # imagePullSecrets:
      # - name: ghcr-secret

---
# Headless service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: worker-service
  namespace: piyasa-chatbot
  labels:
    app: piyasa-worker
spec:
  clusterIP: None
  ports:
  - port: 8001
    name: metrics
    protocol: TCP
  selector:
    app: piyasa-worker
    component: worker
