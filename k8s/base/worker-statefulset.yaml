apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: worker
  namespace: piyasa-chatbot
  labels:
    app: piyasa-worker
    component: worker
spec:
  serviceName: worker-service
  replicas: 4
  selector:
    matchLabels:
      app: piyasa-worker
      component: worker
  template:
    metadata:
      labels:
        app: piyasa-worker
        component: worker
    spec:
      containers:
      - name: worker
        image: ghcr.io/uzaktantakip000-create/piyasa_chat_bot/api:latest
        imagePullPolicy: Always
        # Wrapper script to extract WORKER_ID from pod name
        # StatefulSet pods are named: worker-0, worker-1, worker-2, etc.
        # We extract the ordinal number and export it as WORKER_ID
        command:
          - /bin/sh
          - -c
          - |
            # Extract ordinal from pod name (worker-0 -> 0, worker-1 -> 1, etc.)
            export WORKER_ID=$(echo $POD_NAME | grep -oE '[0-9]+$')
            echo "Starting worker with WORKER_ID=$WORKER_ID, TOTAL_WORKERS=$TOTAL_WORKERS"
            # Start application
            exec python worker.py
        env:
        # POD_NAME for extracting worker ordinal
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        # ConfigMap references
        - name: DATABASE_URL
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: REDIS_URL
        - name: LLM_PROVIDER
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: LLM_PROVIDER
        - name: LLM_MODEL
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: LLM_MODEL
        - name: TELEGRAM_API_BASE
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: TELEGRAM_API_BASE
        - name: TELEGRAM_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: TELEGRAM_TIMEOUT
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: LOG_LEVEL
        - name: TOTAL_WORKERS
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: TOTAL_WORKERS
        - name: CACHE_L1_MAX_SIZE
          valueFrom:
            configMapKeyRef:
              name: piyasa-config
              key: CACHE_L1_MAX_SIZE
        # Secret references
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: OPENAI_API_KEY
        - name: GROQ_API_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: GROQ_API_KEY
        - name: GEMINI_API_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: GEMINI_API_KEY
        - name: TOKEN_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: piyasa-secrets
              key: TOKEN_ENCRYPTION_KEY
        # NOTE: WORKER_ID is now dynamically extracted in the command wrapper
        # from POD_NAME (no explicit env var needed)
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
      # Image pull secret (if using private registry)
      # imagePullSecrets:
      # - name: ghcr-secret

---
# Headless service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: worker-service
  namespace: piyasa-chatbot
  labels:
    app: piyasa-worker
spec:
  clusterIP: None
  selector:
    app: piyasa-worker
    component: worker
